name: CI/CD - Build & Push to DockerHub

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_REPO: yeongo05/freedom-app
      TAG_SHA: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build (skip tests for now)
        run: ./gradlew clean build -x test --parallel

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push main-server
        uses: docker/build-push-action@v6
        with:
          context: .
          file: main-server/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE_REPO }}:main
            ${{ env.IMAGE_REPO }}:main-${{ env.TAG_SHA }}

      - name: Build & Push admin-server
        uses: docker/build-push-action@v6
        with:
          context: .
          file: admin-server/Dockerfile
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE_REPO }}:admin
            ${{ env.IMAGE_REPO }}:admin-${{ env.TAG_SHA }}

      - name: Notify Discord
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            COLOR=65280  # 초록색
            EMOJI="✅"
            STATUS_TEXT="성공"
          else
            COLOR=16711680  # 빨간색
            EMOJI="❌"
            STATUS_TEXT="실패"
          fi
          
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{
              "username": "🤖 Financial Freedom CI/CD",
              "avatar_url": "https://cdn.discordapp.com/embed/avatars/4.png",
              "embeds": [{
                "title": "'$EMOJI' 배포 완료",
                "description": "Financial Freedom 시스템이 성공적으로 배포되었습니다!",
                "color": '$COLOR',
                "fields": [
                  {
                    "name": "🔀 브랜치",
                    "value": "`${{ github.ref_name }}`",
                    "inline": true
                  },
                  {
                    "name": "📦 커밋",
                    "value": "`${{ github.sha }}`",
                    "inline": true
                  },
                  {
                    "name": "✅ 상태",
                    "value": "`'$STATUS_TEXT'`",
                    "inline": true
                  },
                  {
                    "name": "🚀 서버",
                    "value": "Main Server: `${{ env.IMAGE_REPO }}:main`\nAdmin Server: `${{ env.IMAGE_REPO }}:admin`",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Financial Freedom Admin System",
                  "icon_url": "https://cdn.discordapp.com/embed/avatars/5.png"
                },
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
