<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>퀴즈 관리 - 파이낸셜 프리덤</title>
    <link rel="icon" href="/admin/static/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/admin/static/admin/css/admin-common.css" rel="stylesheet">
</head>
<body>
<div class="admin-wrapper">
    <div th:replace="~{admin/common/sidebar :: sidebar}"></div>
    <div class="admin-content">
        <div th:replace="~{admin/common/header :: header('퀴즈 관리', 'fas fa-question-circle', '퀴즈 추가')}"></div>
        <main class="page-content">
            <div class="row mb-3">
                <div class="col-md-12 text-end">
                    <button id="autoGenerateBtn" class="btn btn-warning me-2" disabled>
                        <i class="fas fa-magic me-2"></i>퀴즈 자동생성
                    </button>
                    <a href="/admin/quiz/create" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>퀴즈 추가
                    </a>
                </div>
            </div>
            <div class="row" id="quizCardContainer">
                <div class="col-12 text-center text-muted py-4">퀴즈 데이터를 불러오는 중입니다...</div>
            </div>
            <nav class="mt-4">
                <ul class="pagination justify-content-center" id="quizPagination"></ul>
            </nav>
        </main>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/static/admin/js/admin-common.js"></script>
<script>
    $(document).ready(function() {
        $('[data-page="quiz"]').addClass('active');
        loadQuizList();
        setupAutoGenerateButton();
    });

    function setupAutoGenerateButton() {
        const now = new Date();
        const enableDate = new Date('2026-09-01');
        const btn = $('#autoGenerateBtn');
        
        if (now >= enableDate) {
            btn.prop('disabled', false);
            btn.removeClass('btn-warning').addClass('btn-success');
            btn.attr('title', '퀴즈 자동생성 사용 가능');
            btn.click(function() {
                if (confirm('외부 API에서 퀴즈를 자동 생성하시겠습니까? 시간이 다소 소요될 수 있습니다.')) {
                    autoGenerateQuizzes();
                }
            });
        } else {
            btn.prop('disabled', true);
            btn.attr('title', '2026년 9월 1일부터 사용 가능합니다.');
            btn.click(function() {
                alert('퀴즈 자동생성은 2026년 9월 1일부터 사용 가능합니다.');
            });
        }
    }

    function autoGenerateQuizzes() {
        const btn = $('#autoGenerateBtn');
        const originalText = btn.html();
        
        // 버튼 비활성화 및 로딩 표시
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>생성 중...');
        
        $.ajax({
            url: '/admin/api/quiz/import',
            method: 'POST',
            success: function(response) {
                alert(`퀴즈 자동생성이 완료되었습니다. ${response.importedCount}개의 퀴즈가 생성되었습니다.`);
                loadQuizList(0); // 첫 페이지로 새로고침
            },
            error: function(xhr) {
                alert('퀴즈 자동생성에 실패했습니다: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
            },
            complete: function() {
                // 버튼 원래 상태로 복원
                btn.prop('disabled', false);
                btn.html(originalText);
            }
        });
    }

    let currentPage = 0; const pageSize = 12;
    function loadQuizList(page = 0) {
        currentPage = page;
        $.ajax({
            url: '/admin/api/quiz', method: 'GET', data: { page: page, size: pageSize },
            success: function(resp) { renderQuizCards(resp.content); renderQuizPagination(resp); },
            error: function() { $('#quizCardContainer').html('<div class="col-12 text-center text-danger py-4">퀴즈 목록 로드 실패</div>'); }
        });
    }

    function renderQuizCards(items) {
        const wrap = $('#quizCardContainer');
        if (!items || items.length === 0) { wrap.html('<div class="col-12 text-center text-muted py-4">등록된 퀴즈가 없습니다.</div>'); return; }
        let html = '';
        items.forEach(function(q){
            const typeBadge = q.type === 'OX' ? '<span class="badge bg-primary">OX</span>' : '<span class="badge bg-success">4지선다</span>';
            const newsLink = q.newsArticleId ? '<a href="/admin/news/'+q.newsArticleId+'" class="text-decoration-none" target="_blank">원본보기</a>' : '';
            html += '<div class="col-lg-4 col-md-6 mb-4">'
                 +   '<div class="card h-100 shadow-sm">'
                 +     '<div class="card-body">'
                 +       '<div class="d-flex justify-content-between align-items-center mb-2">'
                 +         '<div>'+typeBadge+' <span class="badge bg-secondary ms-2">'+ (q.category || '') +'</span></div>'
                 +         '<a href="/admin/quiz/'+q.id+'" class="btn btn-sm btn-outline-primary">상세</a>'
                 +       '</div>'
                 +       '<div class="fw-semibold">'+ escapeHtml(q.question) +'</div>'
                 +     '</div>'
                 +     '<div class="card-footer d-flex justify-content-between">'
                 +       '<small>퀴즈 ID: '+q.id+'</small>'
                 +       '<small>'+newsLink+'</small>'
                 +     '</div>'
                 +   '</div>'
                 + '</div>';
        });
        wrap.html(html);
    }

    function renderQuizPagination(p){
        const pg = $('#quizPagination'); let html = '';
        if (p.hasPrevious) html += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadQuizList('+(p.page-1)+')">이전</a></li>'; else html += '<li class="page-item disabled"><span class="page-link">이전</span></li>';
        const total = p.totalPages; const start = Math.max(0, currentPage-2); const end = Math.min(total-1, currentPage+2);
        for (let i=start;i<=end;i++){ if(i===currentPage) html += '<li class="page-item active"><span class="page-link">'+(i+1)+'</span></li>'; else html += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadQuizList('+i+')">'+(i+1)+'</a></li>'; }
        if (p.hasNext) html += '<li class="page-item"><a class="page-link" href="javascript:void(0)" onclick="loadQuizList('+(p.page+1)+')">다음</a></li>'; else html += '<li class="page-item disabled"><span class="page-link">다음</span></li>';
        pg.html(html);
    }

    function escapeHtml(s){ return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }
</script>
</body>
</html>
